<div>
	<h4 align="center">Request Details </h4>
	<div class="row-fluid new-header">
		<div class="header-line">
			<a data-toggle="collapse" data-parent="#accordion" href="#main_details">Main Details</a>
			<span> ( Request Id: <span data-bind="text: id"> </span> 
			<span>) </span>
			<div class="pull-right">
				<a href="javascript:void(0)" data-bind="if: mainEditVisible, click: makeMainEdit">Edit</a>
				<a href="javascript:void(0)" data-bind="if: mainSaveVisible, click: makeMainSave">Save</a>
			</div>
			</div>
		</div>
		<div id="main_details" class="panel-collapse collapse in">
			<div class="row-fluid new-line">
				<div class="span11">
					<span>Category : </span>
					<select class="input-small" data-bind="enable: $root.mainEditable, options: categories, optionsText: 'name',
                          value: selectedCategory,
                          optionsCaption: 'Choose...'">
	        	    </select>
				</div>
			</div>
			<div class="row-fluid new-line">
				<div class="span5">
					<span> Request Description : </span>
					<input type="text" class="input-large" data-bind="enable: $root.mainEditable, value: requestDescription"></input>
				</div>
				<div class="span3">
					<span> Pipe Line Request : </span>
					<label class="radio inline">
						<input type="radio" value="Yes" data-bind="enable: $root.mainEditable, checked: requestPipeLine">Yes</input>
					</label>
					<label class="radio inline">
						<input type="radio" value="No" data-bind="enable: $root.mainEditable, checked: requestPipeLine">No</input>
					</label>
				</div>
				<div class="span3">
					<span> Total Requests : </span>
					<input type="text" class="input-mini" data-bind="enable: $root.mainEditable, value:totalRequests"></input>
				</div>
			</div>
			<div class="row-fluid new-line">
				<div class="span5">
					<span> Response Description : </span>
					<input type="text" class="input-large" data-bind="enable: $root.mainEditable, value: responseDescription"></input>
				</div>
				<div class="span3">
					<span> Pipe Line Response : </span>
                    <label class="radio inline">
                        <input type="radio" value="Yes" data-bind="enable: $root.mainEditable, checked: responsePipeLine">Yes</input>
                    </label>
                    <label class="radio inline">
                        <input type="radio" value="No" data-bind="enable: $root.mainEditable, checked: responsePipeLine">No</input>
                    </label>
				</div>
				<div class="span3">
					<span> Total Responses : </span>
                    <input type="text" class="input-mini" data-bind="enable: $root.mainEditable, value:totalResponses"></input>
				</div>
			</div>
		</div>
	</div>
	<div class="row-fluid new-header">
		<div class="header-line">
			<a data-toggle="collapse" data-parent="#accordion" href="#request_details">Request Details</a>
			<div class="pull-right">
				<a href="javascript:void(0)" data-bind="if: requestEditVisible, click: makeRequestEdit">Edit</a>
				<a href="javascript:void(0)" data-bind="if: requestSaveVisible, click: makeRequestSave">Save</a>
			</div>
		</div>
		<div id="request_details" class="panel-collapse collapse">
			<div class="row-fluid new-line">
				<div class="span11 over-flow">
					<span class=pull-left"> Search </span>
					<input class=pull-left" data-bind="value: requestFilter, valueUpdate: 'keyup'" placeholder= 'Type Ids: 1,2'></input>
					<table id="request_table" width=100% class="table new-table table-striped table-bordered table-hover table-condensed">
                        <thead class="dataTableHeader">
                            <tr>
								<th>Id</th>
								<th>Type</th>
								<th colspan="6">Details</th>
							</tr>
						</thead>
						<tbody data-bind="foreach: subRequests">
							<tr class="new-table-header" data-bind="visible: showRequest">
                                <td class="search-col" data-bind="text: id, attr:{ 'rowspan': totalRow}">1</td>
								<td rowspan="2">Request</td>
                                <td>Method</td>
                                <td>Request Headers</td>
                                <td>Version</td>
                                <td>Data Present</td>
                                <td>Server Request</td>
                                <td>Delay Request</td>
                            </tr>
							<tr class="info" data-bind="visible: showRequest">
								<td>
									<select class="input-small" data-bind="enable: $root.requestEditable, options: methods.available, optionsText: 'name',
                    			      value: methods.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td>
									<textarea type="text" data-bind="enable: $root.requestEditable, value: requestHeaders"/>
								</td>
                                <td>
									<input class="input-mini" type="text" data-bind="enable: $root.requestEditable, value: version"/>
								</td>
                                <td>
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: data.available,
                    			      value: data.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td>
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: serverRequest.available,
                    			      value: serverRequest.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td>
									<input class="input-mini" type="text" data-bind="enable: $root.requestEditable, value:delayRequest"/>
								</td>
							</tr>
							<tr class="new-table-header" data-bind="visible: showRequest">
								<td rowspan="2">Verification</td>
                                <td colspan="1">Response Code</td>
                                <td colspan="1">Response Headers</td>
                                <td colspan="1">Version</td>
                                <td colspan="1">Is Single Value header</td>
                                <td colspan="1">Verify Data</td>
                                <td colspan="1"></td>
							</tr>
							<tr class="info" data-bind="visible: showRequest">
                                <td colspan="1">
									<select class="input-small" data-bind="enable: $root.requestEditable, options: verifyCode.available,
                    			      value: verifyCode.selected, optionsText: 'name',
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1">
									<textarea type="text" data-bind="enable: $root.requestEditable, value: verifyRespHdrs"/>
								</td>
                                <td colspan="1">
									<input class="input-mini" type="text" data-bind="enable: $root.requestEditable, value: verifyVersion"/>
								</td>
                                <td colspan="1">
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: verifySingHdr.available,
                    			      value: verifySingHdr.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1">
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: verifyDataCheck.available,
                    			      value: verifyDataCheck.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1"></td>
							</tr>
							<tr class="new-table-header" data-bind="with: subResponse, visible: showResponse">
								<td rowspan="2">Response</td>
                                <td>Response Code</td>
                                <td colspan="1">Response Headers</td>
                                <td>Version</td>
                                <td>Data Present</td>
                                <td colspan="1"></td>
                                <td colspan="1"></td>
							</tr>
							<tr class="info" data-bind="with: subResponse, visible: showResponse">
								<td>
									<select class="input-small" data-bind="enable: $root.requestEditable, options: responseCode.available,
                    			      value: responseCode.selected, optionsText: 'name',
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1">
									<textarea data-bind="enable: $root.requestEditable, value: responseHeaders"/>
								</td>
                                <td>
									<input class="input-mini" type="text" data-bind="enable: $root.requestEditable, value: version"/>
								</td>
                                <td>
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: data.available,
                    			      value: data.selected,
            		            	  optionsCaption: 'Choose...'">
                                </td>
                                <td colspan="1"></td>
                                <td colspan="1"></td>
							</tr>
							<tr class="new-table-header" data-bind="with: subResponse, visible: showResponse">
								<td rowspan="2">Verification</td>
                                <td colspan="1">Method</td>
                                <td colspan="1">Request Headers</td>
                                <td colspan="1">Version</td>
                                <td colspan="1">Is Single Value header</td>
                                <td colspan="1">Verify Data</td>
                                <td colspan="1"></td>
							</tr>
							<tr class="info" data-bind="with: subResponse, visible: showResponse">
                                <td colspan="1">
									<select class="input-small" data-bind="enable: $root.requestEditable, options: verifyMethod.available,
                    			      value: verifyMethod.selected, optionsText: 'name',
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1">
									<textarea class="form-control" data-bind="enable: $root.requestEditable, value: verifyReqHdrs"/>
								</td>
                                <td colspan="1">
									<input class="input-mini" type="text" data-bind="enable: $root.requestEditable, value: verifyVersion">
								</td>
                                <td colspan="1">
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: verifySingHdr.available,
                    			      value: verifySingHdr.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1">
									<select class="input-mini" data-bind="enable: $root.requestEditable, options: verifyDataCheck.available,
                    			      value: verifyDataCheck.selected,
            		            	  optionsCaption: 'Choose...'">
					        	    </select>
								</td>
                                <td colspan="1"></td>
							</tr>
							<tr class="error" data-bind="visible: showRequest">
								<td colspan="8"></td>
							</tr>
                        </tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
(function(httpRequestResponseBuilder, $, undefined){
	
	var subResponseDetails = function subResponseDetails(data){
		var self = this;
		
		var fullData = data || {};
		var response = fullData.data || {};
		response.codes = fullData.codes || [];
		response.methods = fullData.methods || [];
		
		self.id = ko.observable(response.id || 0);
		self.request_id = ko.observable(response.request_id);
		
		self.responseHeaders = ko.observable(response.response_headers || []);
		self.version = ko.observable(response.version || '1.1');
		self.verifyVersion = ko.observable(response.verify_version || '1.1');
		self.verifyReqHdrs = ko.observable( response.verify_req_hdrs || '');
        self.verifyDataCheck = {
				available: ko.observableArray([ 'Yes', 'No']),
				selected: ko.observable( response.verify_data_checksum ? "Yes" : "No")
		}
		
        self.data = {
			available : ko.observableArray([ 'Yes', 'No']),
			selected : ko.observable(response.data_size != 0 ? "Yes" : "No")
		}
		
        self.responseCode = {
			available : ko.observableArray(response.codes || []),
			selected  : ko.computed(function(){
	            return ko.utils.arrayFirst(response.codes || [], function(item) {
    	            return parseInt(item.id) === response.selected_response_code;
        	    })
        	})
		}
		self.verifyMethod = {
			available : ko.observable(response.methods || []),
			selected  : ko.computed(function(){
	            return ko.utils.arrayFirst(response.methods || [], function(item) {
    	            return parseInt(item.id) === response.verify_method_id;
        	    })
        	})
		}
        self.verifySingHdr = {
			available : ko.observableArray([ 'Yes', 'No']),
			selected : ko.observable(response.verify_single_header ? "Yes" : "No")
		}
	};	

	var subRequestDetails = function subRequestDetails(data){
		var self = this;
		
		var request = data || {};
		
		self.id = ko.observable(request.id || 0);
		self.methods = {
			available : ko.observable(request.methods || []),
			selected  : ko.computed(function(){
	            return ko.utils.arrayFirst(request.methods || [], function(item) {
    	            return parseInt(item.id) === request.selected_method_id;
        	    })
        	})
		}
        self.serverRequest = {
			available : ko.observableArray([ 'Yes', 'No']),
			selected : ko.observable(request.server_request ? "Yes" : "No")
		}
        self.data = {
			available : ko.observableArray([ 'Yes', 'No']),
			selected : ko.observable(request.data_size != 0 ? "Yes" : "No")
		}
		self.requestHeaders = ko.observable(request.request_headers || []);
		self.version = ko.observable(request.version || '1.1');
		self.delayRequest = ko.observable(request.request_delay || 0);
		self.dataSize = ko.observable(request.data_size || 0);
        self.verifySingHdr = {
			available : ko.observableArray([ 'Yes', 'No']),
			selected : ko.observable(request.verify_single_header ? "Yes" : "No")
		}
        self.verifyCode = {
			available : ko.observableArray(request.codes || []),
			selected  : ko.computed(function(){
	            return ko.utils.arrayFirst(request.codes || [], function(item) {
    	            return parseInt(item.id) === request.verify_code;
        	    })
        	})
		}
		self.verifyVersion = ko.observable(request.verify_version || '1.1');
		self.verifyRespHdrs = ko.observable(request.verify_resp_hdrs || []);
        self.verifyDataCheck = {
				available: ko.observableArray([ 'Yes', 'No']),
				selected: ko.observable( request.verify_data_checksum ? "Yes" : "No")
		}
		self.subResponse = ko.observable(new subResponseDetails(
											{ data: data.sub_response_details,
											  codes : request.codes,
											  methods : request.methods
											}));
		
		self.showRequest = ko.observable(true);
		self.showResponse = ko.computed(function(){
			return self.showRequest() && data.sub_response_details;
		});
		self.totalRow = ko.computed(function(){
			if ( self.showResponse() ){
				return 8;
			}
			return 4;
		})
	};	


	httpRequestResponseBuilder.SingleRequestViewModel = function SingleRequestViewModel(data){
		var self = this;
		var mainDetail = data.main_details || {};
		
		//Main Details edit/save controllers
		self.mainEditable = ko.observable(false);		
		self.mainEditVisible = ko.observable(true);
		self.mainSaveVisible = ko.observable(false);
		
		self.makeMainEdit = function(){
			self.mainEditable(true);
			self.mainEditVisible(false);
			self.mainSaveVisible(true);
		}
		self.makeMainSave = function(){
			self.mainEditable(false);
			self.mainEditVisible(true);
			self.mainSaveVisible(false);
		}
		
		//Request Details edit/save controllers
		self.requestEditable = ko.observable(false);		
		self.requestEditVisible = ko.observable(true);
		self.requestSaveVisible = ko.observable(false);
		self.makeRequestEdit = function(){
			self.requestEditable(true);
			self.requestEditVisible(false);
			self.requestSaveVisible(true);
		}
		self.makeRequestSave = function(){
			self.requestEditable(false);
			self.requestEditVisible(true);
			self.requestSaveVisible(false);
		}
		
		self.categories = ko.observableArray(data.categories || []);
		self.selectedCategory = ko.computed(function(){
			return ko.utils.arrayFirst(self.categories(), function(item) {
				return parseInt(item.id) === mainDetail.request_category_id;
			})
		})

		self.id = ko.observable( mainDetail.id || 0);
		
		/* Request Details */
		self.requestDescription = ko.observable(mainDetail.request_description || '');
		self.requestPipeLine = ko.observable(mainDetail.request_pipe_line ? "Yes":'No');
		self.totalRequests = ko.observable(mainDetail.total_requests || 0 );
		
		self.subRequests = ko.observableArray( $.map(data.sub_request_details || [], function(request){
			request.methods = data.methods || [];
			request.codes = data.codes || [];
			return new subRequestDetails(request);
		}));
		self.requestFilter = ko.observable();
		self.requestFilter.subscribe(function(value){
			if (value == '' ){
				$.each(self.subRequests() || [], function(index, item){
					item.showRequest(true)
				})
			}
			else{
				$.each(self.subRequests() || [], function(index, item){
					item.showRequest(false);
				})
				var ids = value.split(',');
				$.map(ids, function(id){
					var item =  ko.utils.arrayFirst(self.subRequests() || [], function(item) {
				        return item.id() == id;
					})
					if ( item ){
						item.showRequest(true);
					}
				})
			}
		});
		
		/* Response Details */
		self.responseDescription = ko.observable(mainDetail.response_description || '');
		self.responsePipeLine = ko.observable(mainDetail.response_pipe_line ? "Yes":'No');
		self.totalResponses = ko.observable(mainDetail.total_responses || 0 );
		
	}
}(Application.namespace("Application.httpRequestResponseBuilder"), jQuery))

var applyFormBindings = function(data, tab_id){
	ko.applyBindings(new Application.httpRequestResponseBuilder.SingleRequestViewModel(data), $(tab_id)[0]);
};

</script>
